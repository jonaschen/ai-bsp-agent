name: Publish Compliance Issues

# Triggered on push to the audit branch when this workflow file or either issue
# body file changes. Also available as a manual dispatch.
# Re-running is safe: the job checks for duplicate titles before creating.
"on":
  push:
    branches:
      - "copilot/audit-agents-md-compliance"
    paths:
      - ".github/workflows/create-compliance-issues.yml"
      - ".github/compliance-issues/*.md"
  workflow_dispatch:

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Issue 1 ‚Äî Optimizer ACL Enforcement (AGENTS.md ¬ß4)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: "üîí [Compliance] Optimizer lacks sandboxing and ACL enforcement ‚Äî Direct violation of AGENTS.md ¬ß4"
          ISSUE_BODY_FILE: ".github/compliance-issues/issue-optimizer-acl.md"
        run: |
          # Idempotency: skip if issue already exists
          existing=$(gh issue list --repo "${{ github.repository }}" \
            --state open --search "$ISSUE_TITLE" --json title --jq '.[].title')
          if echo "$existing" | grep -qF "$ISSUE_TITLE"; then
            echo "Issue 1 already exists, skipping."
          else
            gh issue create \
              --repo "${{ github.repository }}" \
              --title "$ISSUE_TITLE" \
              --body-file "$ISSUE_BODY_FILE" \
              --label "bug"
            echo "Issue 1 created successfully."
          fi

      - name: Create Issue 2 ‚Äî Architect Stability Protocol (AGENTS.md ¬ß1.1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: "üîÅ [Compliance] Architect refactor retry limit not implemented ‚Äî Violates AGENTS.md ¬ß1.1 TDD Stability Protocol"
          ISSUE_BODY_FILE: ".github/compliance-issues/issue-architect-stability.md"
        run: |
          # Idempotency: skip if issue already exists
          existing=$(gh issue list --repo "${{ github.repository }}" \
            --state open --search "$ISSUE_TITLE" --json title --jq '.[].title')
          if echo "$existing" | grep -qF "$ISSUE_TITLE"; then
            echo "Issue 2 already exists, skipping."
          else
            gh issue create \
              --repo "${{ github.repository }}" \
              --title "$ISSUE_TITLE" \
              --body-file "$ISSUE_BODY_FILE" \
              --label "bug"
            echo "Issue 2 created successfully."
          fi
